<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3. Spatial joins and filters • sfnetworks</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="3. Spatial joins and filters">
<meta property="og:description" content="sfnetworks">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">sfnetworks</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/structure.html">1. The sfnetwork data structure</a>
    </li>
    <li>
      <a href="../articles/preprocess_and_clean.html">2. Network pre-processing and cleaning</a>
    </li>
    <li>
      <a href="../articles/join_filter.html">3. Spatial joins and filters</a>
    </li>
    <li>
      <a href="../articles/routing.html">4. Routing</a>
    </li>
    <li>
      <a href="../articles/morphers.html">5. Spatial morphers</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/luukvdmeer/sfnetworks/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="join_filter_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>3. Spatial joins and filters</h1>
            
            <h4 class="date">2021-02-01</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/luukvdmeer/sfnetworks/blob/master/vignettes/join_filter.Rmd"><code>vignettes/join_filter.Rmd</code></a></small>
      <div class="hidden name"><code>join_filter.Rmd</code></div>

    </div>

    
    
<style type="text/css" scoped>
PRE.fansi SPAN {padding-top: .25em; padding-bottom: .25em};
</style>
<p>The integration with <code>sf</code> and addition of several spatial network specific functions in <code>sfnetworks</code> allow to easily filter information from a network based on spatial relationships, and to join new information into a network based on spatial relationships. This vignette presents several ways to do that.</p>
<p>Both spatial filters and spatial joins use spatial predicate functions to examine spatial relationships. Spatial predicates are mathematically defined binary spatial relations between two simple feature geometries. Often used examples include the predicate <em>equals</em> (geometry x is equal to geometry y) and the predicate <em>intersects</em> (geometry x has at least one point in common with geometry y). For an overview of all available spatial predicate functions in <code>sf</code> and links to detailed explanations of the underlying algorithms, see <a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">here</a>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://luukvdmeer.github.io/sfnetworks/">sfnetworks</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidygraph.data-imaginist.com">tidygraph</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://igraph.org">igraph</a></span><span class="op">)</span></code></pre></div>
<div id="spatial-filters" class="section level2">
<h2 class="hasAnchor">
<a href="#spatial-filters" class="anchor"></a>Spatial filters</h2>
<div id="using-st_filter" class="section level3">
<h3 class="hasAnchor">
<a href="#using-st_filter" class="anchor"></a>Using st_filter</h3>
<p>Information can be filtered from a network by using spatial predicate functions inside the sf function <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">sf::st_filter()</a></code>, which works as follows: the function is applied to a set of geometries A with respect to another set of geometries B, and removes features from A based on their spatial relation with the features in B. A practical example: when using the predicate <em>intersects</em>, all geometries in A that do not intersect with any geometry in B are removed.</p>
<p>When applying <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">sf::st_filter()</a></code> to a sfnetwork, it is internally applied to the active element of that network. For example: filtering information from a network A with activated nodes, using a set of polygons B and the predicate <em>intersects</em>, will remove those nodes that do not intersect with any of the polygons in B from the network. When edges are active, it will remove the edges that do not intersect with any of the polygons in B from the network.</p>
<p>Although the filter is applied only to the active element of the network, it may also affect the other element. When nodes are removed, their incident edges are removed as well. However, when edges are removed, the nodes at their endpoints remain, even if they don’t have any other incident edges. This behavior is inherited from <code>tidygraph</code> and understandable from a graph theory point of view: by definition nodes can exist peacefully in isolation, while edges can never exist without nodes at their endpoints.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p1</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4151358</span>, <span class="fl">3208045</span><span class="op">)</span><span class="op">)</span>
<span class="va">p2</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4151340</span>, <span class="fl">3207520</span><span class="op">)</span><span class="op">)</span>
<span class="va">p3</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4151756</span>, <span class="fl">3207506</span><span class="op">)</span><span class="op">)</span>
<span class="va">p4</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4151774</span>, <span class="fl">3208031</span><span class="op">)</span><span class="op">)</span>

<span class="va">poly</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_multipoint</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, <span class="va">p3</span>, <span class="va">p4</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html">st_cast</a></span><span class="op">(</span><span class="st">"POLYGON"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="fl">3035</span><span class="op">)</span>

<span class="va">net</span> <span class="op">=</span> <span class="fu"><a href="../reference/as_sfnetwork.html">as_sfnetwork</a></span><span class="op">(</span><span class="va">roxel</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fl">3035</span><span class="op">)</span>

<span class="va">filtered</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_filter</a></span><span class="op">(</span><span class="va">net</span>, <span class="va">poly</span>, .pred <span class="op">=</span> <span class="va">st_intersects</span><span class="op">)</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">net</span>, col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">poly</span>, border <span class="op">=</span> <span class="st">"red"</span>, lty <span class="op">=</span> <span class="fl">4</span>, lwd <span class="op">=</span> <span class="fl">4</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">filtered</span><span class="op">)</span></code></pre></div>
<p><img src="join_filter_files/figure-html/unnamed-chunk-2-1.png" width="50%"><img src="join_filter_files/figure-html/unnamed-chunk-2-2.png" width="50%"></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">filtered</span> <span class="op">=</span> <span class="va">net</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html">activate</a></span><span class="op">(</span><span class="st">"edges"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_filter</a></span><span class="op">(</span><span class="va">poly</span>, .pred <span class="op">=</span> <span class="va">st_intersects</span><span class="op">)</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">net</span>, col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">poly</span>, border <span class="op">=</span> <span class="st">"red"</span>, lty <span class="op">=</span> <span class="fl">4</span>, lwd <span class="op">=</span> <span class="fl">4</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">filtered</span><span class="op">)</span></code></pre></div>
<p><img src="join_filter_files/figure-html/unnamed-chunk-3-1.png" width="50%"><img src="join_filter_files/figure-html/unnamed-chunk-3-2.png" width="50%"></p>
<p>The isolated nodes that remain after filtering the edges can be easily removed using a combination of a regular <code><a href="https://dplyr.tidyverse.org/reference/filter.html">dplyr::filter()</a></code> verb and the <code><a href="https://tidygraph.data-imaginist.com/reference/node_types.html">tidygraph::node_is_isolated()</a></code> query function.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">filtered</span> <span class="op">=</span> <span class="va">net</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html">activate</a></span><span class="op">(</span><span class="st">"edges"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_filter</a></span><span class="op">(</span><span class="va">poly</span>, .pred <span class="op">=</span> <span class="va">st_intersects</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html">activate</a></span><span class="op">(</span><span class="st">"nodes"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/node_types.html">node_is_isolated</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">net</span>, col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">poly</span>, border <span class="op">=</span> <span class="st">"red"</span>, lty <span class="op">=</span> <span class="fl">4</span>, lwd <span class="op">=</span> <span class="fl">4</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">filtered</span><span class="op">)</span></code></pre></div>
<p><img src="join_filter_files/figure-html/unnamed-chunk-4-1.png" width="50%"><img src="join_filter_files/figure-html/unnamed-chunk-4-2.png" width="50%"></p>
<p>For non-spatial filters applied to attribute columns, simply use <code><a href="https://dplyr.tidyverse.org/reference/filter.html">dplyr::filter()</a></code> instead of <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">sf::st_filter()</a></code>.</p>
</div>
<div id="using-spatial-node-and-edge-query-functions" class="section level3">
<h3 class="hasAnchor">
<a href="#using-spatial-node-and-edge-query-functions" class="anchor"></a>Using spatial node and edge query functions</h3>
<p>In <code>tidygraph</code>, filtering information from networks is done by using specific node or edge query functions inside the <code><a href="https://dplyr.tidyverse.org/reference/filter.html">dplyr::filter()</a></code> verb. An example was already shown above, where isolated nodes were removed from the network.</p>
<p>In <code>sfnetworks</code>, several spatial predicates are implemented as node and edge query functions such that you can also do spatial filtering in tidygraph style. See <a href="https://luukvdmeer.github.io/sfnetworks/reference/spatial_node_predicates.html">here</a> for a list of all implemented spatial node query functions, and <a href="https://luukvdmeer.github.io/sfnetworks/reference/spatial_edge_predicates.html">here</a> for the spatial edge query functions.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">filtered</span> <span class="op">=</span> <span class="va">net</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html">activate</a></span><span class="op">(</span><span class="st">"edges"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="../reference/spatial_edge_predicates.html">edge_intersects</a></span><span class="op">(</span><span class="va">poly</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html">activate</a></span><span class="op">(</span><span class="st">"nodes"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/node_types.html">node_is_isolated</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">net</span>, col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">poly</span>, border <span class="op">=</span> <span class="st">"red"</span>, lty <span class="op">=</span> <span class="fl">4</span>, lwd <span class="op">=</span> <span class="fl">4</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">filtered</span><span class="op">)</span></code></pre></div>
<p><img src="join_filter_files/figure-html/unnamed-chunk-5-1.png" width="50%"><img src="join_filter_files/figure-html/unnamed-chunk-5-2.png" width="50%"></p>
<p>A nice application of this in road networks is to find underpassing and overpassing roads (i.e. edges that cross other edges but are not connected at that point). As we can see in the example below, such roads are not present in our Roxel data, which results in a network without edges.</p>
<p>The <code><a href="https://tidygraph.data-imaginist.com/reference/context_accessors.html">tidygraph::.E()</a></code> function used in the example makes it possible to directly access the complete edges table inside verbs. In this case, that means that for each edge we evaluate if it crosses with <em>any</em> other edge in the network. Similarly, we can use <code><a href="https://tidygraph.data-imaginist.com/reference/context_accessors.html">tidygraph::.N()</a></code> to access the nodes table and <code><a href="https://tidygraph.data-imaginist.com/reference/context_accessors.html">tidygraph::.G()</a></code> to access the network object as a whole.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">net</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html">activate</a></span><span class="op">(</span><span class="st">"edges"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="../reference/spatial_edge_predicates.html">edge_crosses</a></span><span class="op">(</span><span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/context_accessors.html">.E</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre class="fansi fansi-output"><code>#&gt; <span style="color: #555555;"># A sfnetwork with</span><span> </span><span style="color: #555555;">701</span><span> </span><span style="color: #555555;">nodes and</span><span> </span><span style="color: #555555;">0</span><span> </span><span style="color: #555555;">edges
#&gt; #
#&gt; # CRS: </span><span> </span><span style="color: #555555;">EPSG:3035</span><span> </span><span style="color: #555555;">
#&gt; #
#&gt; # A rooted forest with 701 trees with spatially explicit edges
#&gt; #
#&gt; # Edge Data: 0 x 5 (active)</span><span>
#&gt; </span><span style="color: #555555;"># … with 5 variables: from </span><span style="color: #555555;font-style: italic;">&lt;int&gt;</span><span style="color: #555555;">, to </span><span style="color: #555555;font-style: italic;">&lt;int&gt;</span><span style="color: #555555;">, name </span><span style="color: #555555;font-style: italic;">&lt;chr&gt;</span><span style="color: #555555;">, type </span><span style="color: #555555;font-style: italic;">&lt;fct&gt;</span><span style="color: #555555;">,</span><span>
#&gt; </span><span style="color: #555555;">#   geometry </span><span style="color: #555555;font-style: italic;">&lt;GEOMETRY [m]&gt;</span><span>
#&gt; </span><span style="color: #555555;">#
#&gt; # Node Data:     701 x 1</span><span>
#&gt; </span><span style="color: #555555;"># Geometry type: POINT</span><span>
#&gt; </span><span style="color: #555555;"># Dimension:     XY</span><span>
#&gt; </span><span style="color: #555555;"># Bounding box:  xmin: 4150707 ymin: 3206375 xmax: 4152367 ymax: 3208565</span><span>
#&gt;            geometry
#&gt;         </span><span style="color: #555555;font-style: italic;">&lt;POINT [m]&gt;</span><span>
#&gt; </span><span style="color: #555555;">1</span><span> (4151491 3207923)
#&gt; </span><span style="color: #555555;">2</span><span> (4151474 3207946)
#&gt; </span><span style="color: #555555;">3</span><span> (4151398 3207777)
#&gt; </span><span style="color: #555555;"># … with 698 more rows</span><span>
</span></code></pre>
<p>If you just want to store the information about the investigated spatial relation, without filtering the network, you can also use the spatial node and edge query functions inside a <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate()</a></code> verb.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">net</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>in_poly <span class="op">=</span> <span class="fu"><a href="../reference/spatial_node_predicates.html">node_intersects</a></span><span class="op">(</span><span class="va">poly</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre class="fansi fansi-output"><code>#&gt; <span style="color: #555555;"># A sfnetwork with</span><span> </span><span style="color: #555555;">701</span><span> </span><span style="color: #555555;">nodes and</span><span> </span><span style="color: #555555;">851</span><span> </span><span style="color: #555555;">edges
#&gt; #
#&gt; # CRS: </span><span> </span><span style="color: #555555;">EPSG:3035</span><span> </span><span style="color: #555555;">
#&gt; #
#&gt; # A directed multigraph with 14 components with spatially explicit edges
#&gt; #
#&gt; # Node Data:     701 x 2 (active)</span><span>
#&gt; </span><span style="color: #555555;"># Geometry type: POINT</span><span>
#&gt; </span><span style="color: #555555;"># Dimension:     XY</span><span>
#&gt; </span><span style="color: #555555;"># Bounding box:  xmin: 4150707 ymin: 3206375 xmax: 4152367 ymax: 3208565</span><span>
#&gt;            geometry in_poly
#&gt;         </span><span style="color: #555555;font-style: italic;">&lt;POINT [m]&gt;</span><span> </span><span style="color: #555555;font-style: italic;">&lt;lgl&gt;</span><span>  
#&gt; </span><span style="color: #555555;">1</span><span> (4151491 3207923) TRUE   
#&gt; </span><span style="color: #555555;">2</span><span> (4151474 3207946) TRUE   
#&gt; </span><span style="color: #555555;">3</span><span> (4151398 3207777) TRUE   
#&gt; </span><span style="color: #555555;">4</span><span> (4151370 3207673) TRUE   
#&gt; </span><span style="color: #555555;">5</span><span> (4151408 3207539) TRUE   
#&gt; </span><span style="color: #555555;">6</span><span> (4151421 3207592) TRUE   
#&gt; </span><span style="color: #555555;"># … with 695 more rows</span><span>
#&gt; </span><span style="color: #555555;">#
#&gt; # Edge Data:     851 x 5</span><span>
#&gt; </span><span style="color: #555555;"># Geometry type: LINESTRING</span><span>
#&gt; </span><span style="color: #555555;"># Dimension:     XY</span><span>
#&gt; </span><span style="color: #555555;"># Bounding box:  xmin: 4150707 ymin: 3206375 xmax: 4152367 ymax: 3208565</span><span>
#&gt;    from    to name            type                                      geometry
#&gt;   </span><span style="color: #555555;font-style: italic;">&lt;int&gt;</span><span> </span><span style="color: #555555;font-style: italic;">&lt;int&gt;</span><span> </span><span style="color: #555555;font-style: italic;">&lt;chr&gt;</span><span>           </span><span style="color: #555555;font-style: italic;">&lt;fct&gt;</span><span>                             </span><span style="color: #555555;font-style: italic;">&lt;LINESTRING [m]&gt;</span><span>
#&gt; </span><span style="color: #555555;">1</span><span>     1     2 Havixbecker St… resident…       (4151491 3207923, 4151474 3207946)
#&gt; </span><span style="color: #555555;">2</span><span>     3     4 Pienersallee    secondary (4151398 3207777, 4151390 3207727, 4151…
#&gt; </span><span style="color: #555555;">3</span><span>     5     6 Schulte-Bernd-… resident… (4151408 3207539, 4151417 3207573, 4151…
#&gt; </span><span style="color: #555555;"># … with 848 more rows</span><span>
</span></code></pre>
<p>Besides predicate query functions, you can also use the <a href="https://luukvdmeer.github.io/sfnetworks/reference/node_coordinates.html">coordinate query functions</a> for spatial filters on the nodes. For example:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">v</span> <span class="op">=</span> <span class="fl">4152000</span>
<span class="va">l</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_linestring</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">v</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">net</span><span class="op">)</span><span class="op">[</span><span class="st">"ymin"</span><span class="op">]</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">v</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">net</span><span class="op">)</span><span class="op">[</span><span class="st">"ymax"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">filtered_by_coords</span> <span class="op">=</span> <span class="va">net</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html">activate</a></span><span class="op">(</span><span class="st">"nodes"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="../reference/node_coordinates.html">node_X</a></span><span class="op">(</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">v</span><span class="op">)</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">net</span>, col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">l</span>, col <span class="op">=</span> <span class="st">"red"</span>, lty <span class="op">=</span> <span class="fl">4</span>, lwd <span class="op">=</span> <span class="fl">4</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">net</span>, col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">filtered_by_coords</span>, col <span class="op">=</span> <span class="st">"red"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p><img src="join_filter_files/figure-html/unnamed-chunk-8-1.png" width="50%"><img src="join_filter_files/figure-html/unnamed-chunk-8-2.png" width="50%"></p>
</div>
<div id="cropping" class="section level3">
<h3 class="hasAnchor">
<a href="#cropping" class="anchor"></a>Cropping</h3>
<p>Another way to spatially filter features is by using the sf function <code><a href="https://r-spatial.github.io/sf/reference/st_crop.html">sf::st_crop()</a></code>, which works as follows: the function is applied to a set of geometries A with respect to another set of geometries B. It removes features from A that do not <em>intersect</em> with the <em>bounding box</em> of B. On top of that, the geometries of those features from A that remain are updated such that only their intersection with the bounding box of B is kept.</p>
<p>In the case of the nodes, this is equal to a filter using the bounding box of B and the predicate <em>intersects</em>. However, in the case of the edges, there is a difference. The linestring geometries of the edges that intersect with the bounding box of B are cut such that only those parts that are really inside the bounding box of B remain. To preserve a valid spatial network structure, <code>sfnetworks</code> adds new nodes at these cut locations.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cropped</span> <span class="op">=</span> <span class="va">net</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html">activate</a></span><span class="op">(</span><span class="st">"edges"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crop.html">st_crop</a></span><span class="op">(</span><span class="va">poly</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html">activate</a></span><span class="op">(</span><span class="st">"nodes"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/node_types.html">node_is_isolated</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Warning: attribute variables are assumed to be spatially constant throughout all</span>
<span class="co">#&gt; geometries</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">net</span>, col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">poly</span>, border <span class="op">=</span> <span class="st">"red"</span>, lty <span class="op">=</span> <span class="fl">4</span>, lwd <span class="op">=</span> <span class="fl">4</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">filtered</span>, col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">poly</span>, border <span class="op">=</span> <span class="st">"red"</span>, lty <span class="op">=</span> <span class="fl">4</span>, lwd <span class="op">=</span> <span class="fl">4</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">cropped</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p><img src="join_filter_files/figure-html/unnamed-chunk-9-1.png" width="50%"><img src="join_filter_files/figure-html/unnamed-chunk-9-2.png" width="50%"></p>
</div>
</div>
<div id="spatial-joins" class="section level2">
<h2 class="hasAnchor">
<a href="#spatial-joins" class="anchor"></a>Spatial joins</h2>
<div id="using-st_join" class="section level3">
<h3 class="hasAnchor">
<a href="#using-st_join" class="anchor"></a>Using st_join</h3>
<p>Information can be spatially joined into a network by using spatial predicate functions inside the sf function <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">sf::st_join()</a></code>, which works as follows: the function is applied to a set of geometries A with respect to another set of geometries B, and attaches feature attributes from features in B to features in A based on their spatial relation. A practical example: when using the predicate <em>intersects</em>, feature attributes from feature y in B are attached to feature x in A whenever x intersects with y.</p>
<p>When applying <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">sf::st_join()</a></code> to a sfnetwork, it is internally applied to the active element of that network. For example: joining information into network A with activated nodes, from a set of polygons B and using the predicate <em>intersects</em>, will attach attributes from a polygon in B to those nodes that intersect with that specific polygon. When edges are active, it will attach the same information but to the intersecting edges instead.</p>
<p>Lets show this with an example in which we first create imaginary postal code areas for the Roxel dataset.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">codes</span> <span class="op">=</span> <span class="va">net</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_make_grid.html">st_make_grid</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>post_code <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">1000</span> <span class="op">+</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span> <span class="op">*</span> <span class="fl">10</span> <span class="op">-</span> <span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">joined</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_join</a></span><span class="op">(</span><span class="va">net</span>, <span class="va">codes</span>, join <span class="op">=</span> <span class="va">st_intersects</span><span class="op">)</span>
<span class="va">joined</span></code></pre></div>
<pre class="fansi fansi-output"><code>#&gt; <span style="color: #555555;"># A sfnetwork with</span><span> </span><span style="color: #555555;">701</span><span> </span><span style="color: #555555;">nodes and</span><span> </span><span style="color: #555555;">851</span><span> </span><span style="color: #555555;">edges
#&gt; #
#&gt; # CRS: </span><span> </span><span style="color: #555555;">EPSG:3035</span><span> </span><span style="color: #555555;">
#&gt; #
#&gt; # A directed multigraph with 14 components with spatially explicit edges
#&gt; #
#&gt; # Node Data:     701 x 2 (active)</span><span>
#&gt; </span><span style="color: #555555;"># Geometry type: POINT</span><span>
#&gt; </span><span style="color: #555555;"># Dimension:     XY</span><span>
#&gt; </span><span style="color: #555555;"># Bounding box:  xmin: 4150707 ymin: 3206375 xmax: 4152367 ymax: 3208565</span><span>
#&gt;            geometry post_code
#&gt;         </span><span style="color: #555555;font-style: italic;">&lt;POINT [m]&gt;</span><span> </span><span style="color: #555555;font-style: italic;">&lt;chr&gt;</span><span>    
#&gt; </span><span style="color: #555555;">1</span><span> (4151491 3207923) 1020     
#&gt; </span><span style="color: #555555;">2</span><span> (4151474 3207946) 1020     
#&gt; </span><span style="color: #555555;">3</span><span> (4151398 3207777) 1020     
#&gt; </span><span style="color: #555555;">4</span><span> (4151370 3207673) 1020     
#&gt; </span><span style="color: #555555;">5</span><span> (4151408 3207539) 1020     
#&gt; </span><span style="color: #555555;">6</span><span> (4151421 3207592) 1020     
#&gt; </span><span style="color: #555555;"># … with 695 more rows</span><span>
#&gt; </span><span style="color: #555555;">#
#&gt; # Edge Data:     851 x 5</span><span>
#&gt; </span><span style="color: #555555;"># Geometry type: LINESTRING</span><span>
#&gt; </span><span style="color: #555555;"># Dimension:     XY</span><span>
#&gt; </span><span style="color: #555555;"># Bounding box:  xmin: 4150707 ymin: 3206375 xmax: 4152367 ymax: 3208565</span><span>
#&gt;    from    to name            type                                      geometry
#&gt;   </span><span style="color: #555555;font-style: italic;">&lt;int&gt;</span><span> </span><span style="color: #555555;font-style: italic;">&lt;int&gt;</span><span> </span><span style="color: #555555;font-style: italic;">&lt;chr&gt;</span><span>           </span><span style="color: #555555;font-style: italic;">&lt;fct&gt;</span><span>                             </span><span style="color: #555555;font-style: italic;">&lt;LINESTRING [m]&gt;</span><span>
#&gt; </span><span style="color: #555555;">1</span><span>     1     2 Havixbecker St… resident…       (4151491 3207923, 4151474 3207946)
#&gt; </span><span style="color: #555555;">2</span><span>     3     4 Pienersallee    secondary (4151398 3207777, 4151390 3207727, 4151…
#&gt; </span><span style="color: #555555;">3</span><span>     5     6 Schulte-Bernd-… resident… (4151408 3207539, 4151417 3207573, 4151…
#&gt; </span><span style="color: #555555;"># … with 848 more rows</span><span>
</span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">net</span>, col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">codes</span>, col <span class="op">=</span> <span class="cn">NA</span>, border <span class="op">=</span> <span class="st">"red"</span>, lty <span class="op">=</span> <span class="fl">4</span>, lwd <span class="op">=</span> <span class="fl">4</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_centroid</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">codes</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="va">codes</span><span class="op">$</span><span class="va">post_code</span>, cex <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">joined</span>, <span class="st">"edges"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">joined</span>, <span class="st">"nodes"</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fl">20</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p><img src="join_filter_files/figure-html/unnamed-chunk-10-1.png" width="50%"><img src="join_filter_files/figure-html/unnamed-chunk-10-2.png" width="50%"></p>
<p>In the example above, the polygons are spatially distinct. Hence, each node can only intersect with a single polygon. But what would happen if we do a join with polygons that overlap? The attributes from which polygon will then be attached to a node that intersects with multiple polygons at once? In <code>sf</code> this issue is solved by duplicating such a point as much times as the number of polygons it intersects with, and attaching attributes of each intersecting polygon to one of these duplicates. This approach does not fit the network case, however. An edge can only have a single node at each of its endpoints, and thus, the duplicated nodes will be isolated and will be redundant in the network structure. Therefore, <code>sfnetworks</code> will only join the information from the first match whenever there are multiple matches for a single node. A warning is given in that case such that you are aware of the fact that not all information was joined into the network.</p>
<p>Note that in the case of joining on the edges, multiple matches per edge are not a problem for the network structure. It will simply duplicate the edge (i.e. creating a set of parallel edges) whenever this occurs.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">two_equal_polys</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">poly</span>, <span class="va">poly</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>foo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Join on nodes gives a warning that only the first match per node is joined.</span>
<span class="co"># The number of nodes in the resulting network remains the same.</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_join</a></span><span class="op">(</span><span class="va">net</span>, <span class="va">two_equal_polys</span>, join <span class="op">=</span> <span class="va">st_intersects</span><span class="op">)</span>
<span class="co">#&gt; Warning: Multiple matches were detected from some nodes. Only the first match is</span>
<span class="co">#&gt; considered</span></code></pre></div>
<pre class="fansi fansi-output"><code>#&gt; <span style="color: #555555;"># A sfnetwork with</span><span> </span><span style="color: #555555;">701</span><span> </span><span style="color: #555555;">nodes and</span><span> </span><span style="color: #555555;">851</span><span> </span><span style="color: #555555;">edges
#&gt; #
#&gt; # CRS: </span><span> </span><span style="color: #555555;">EPSG:3035</span><span> </span><span style="color: #555555;">
#&gt; #
#&gt; # A directed multigraph with 14 components with spatially explicit edges
#&gt; #
#&gt; # Node Data:     701 x 2 (active)</span><span>
#&gt; </span><span style="color: #555555;"># Geometry type: POINT</span><span>
#&gt; </span><span style="color: #555555;"># Dimension:     XY</span><span>
#&gt; </span><span style="color: #555555;"># Bounding box:  xmin: 4150707 ymin: 3206375 xmax: 4152367 ymax: 3208565</span><span>
#&gt;            geometry foo  
#&gt;         </span><span style="color: #555555;font-style: italic;">&lt;POINT [m]&gt;</span><span> </span><span style="color: #555555;font-style: italic;">&lt;chr&gt;</span><span>
#&gt; </span><span style="color: #555555;">1</span><span> (4151491 3207923) a    
#&gt; </span><span style="color: #555555;">2</span><span> (4151474 3207946) a    
#&gt; </span><span style="color: #555555;">3</span><span> (4151398 3207777) a    
#&gt; </span><span style="color: #555555;">4</span><span> (4151370 3207673) a    
#&gt; </span><span style="color: #555555;">5</span><span> (4151408 3207539) a    
#&gt; </span><span style="color: #555555;">6</span><span> (4151421 3207592) a    
#&gt; </span><span style="color: #555555;"># … with 695 more rows</span><span>
#&gt; </span><span style="color: #555555;">#
#&gt; # Edge Data:     851 x 5</span><span>
#&gt; </span><span style="color: #555555;"># Geometry type: LINESTRING</span><span>
#&gt; </span><span style="color: #555555;"># Dimension:     XY</span><span>
#&gt; </span><span style="color: #555555;"># Bounding box:  xmin: 4150707 ymin: 3206375 xmax: 4152367 ymax: 3208565</span><span>
#&gt;    from    to name            type                                      geometry
#&gt;   </span><span style="color: #555555;font-style: italic;">&lt;int&gt;</span><span> </span><span style="color: #555555;font-style: italic;">&lt;int&gt;</span><span> </span><span style="color: #555555;font-style: italic;">&lt;chr&gt;</span><span>           </span><span style="color: #555555;font-style: italic;">&lt;fct&gt;</span><span>                             </span><span style="color: #555555;font-style: italic;">&lt;LINESTRING [m]&gt;</span><span>
#&gt; </span><span style="color: #555555;">1</span><span>     1     2 Havixbecker St… resident…       (4151491 3207923, 4151474 3207946)
#&gt; </span><span style="color: #555555;">2</span><span>     3     4 Pienersallee    secondary (4151398 3207777, 4151390 3207727, 4151…
#&gt; </span><span style="color: #555555;">3</span><span>     5     6 Schulte-Bernd-… resident… (4151408 3207539, 4151417 3207573, 4151…
#&gt; </span><span style="color: #555555;"># … with 848 more rows</span><span>
</span></code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Join on edges duplicates edges that have multiple matches.</span>
<span class="co"># The number of edges in the resulting network is higher than in the original.</span>
<span class="va">net</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html">activate</a></span><span class="op">(</span><span class="st">"edges"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_join</a></span><span class="op">(</span><span class="va">two_equal_polys</span>, join <span class="op">=</span> <span class="va">st_intersects</span><span class="op">)</span></code></pre></div>
<pre class="fansi fansi-output"><code>#&gt; <span style="color: #555555;"># A sfnetwork with</span><span> </span><span style="color: #555555;">701</span><span> </span><span style="color: #555555;">nodes and</span><span> </span><span style="color: #555555;">989</span><span> </span><span style="color: #555555;">edges
#&gt; #
#&gt; # CRS: </span><span> </span><span style="color: #555555;">EPSG:3035</span><span> </span><span style="color: #555555;">
#&gt; #
#&gt; # A directed multigraph with 14 components with spatially explicit edges
#&gt; #
#&gt; # Edge Data:     989 x 6 (active)</span><span>
#&gt; </span><span style="color: #555555;"># Geometry type: LINESTRING</span><span>
#&gt; </span><span style="color: #555555;"># Dimension:     XY</span><span>
#&gt; </span><span style="color: #555555;"># Bounding box:  xmin: 4150707 ymin: 3206375 xmax: 4152367 ymax: 3208565</span><span>
#&gt;    from    to name          type                                  geometry foo  
#&gt;   </span><span style="color: #555555;font-style: italic;">&lt;int&gt;</span><span> </span><span style="color: #555555;font-style: italic;">&lt;int&gt;</span><span> </span><span style="color: #555555;font-style: italic;">&lt;chr&gt;</span><span>         </span><span style="color: #555555;font-style: italic;">&lt;fct&gt;</span><span>                         </span><span style="color: #555555;font-style: italic;">&lt;LINESTRING [m]&gt;</span><span> </span><span style="color: #555555;font-style: italic;">&lt;chr&gt;</span><span>
#&gt; </span><span style="color: #555555;">1</span><span>     1     2 Havixbecker … residen…    (4151491 3207923, 4151474 3207946) a    
#&gt; </span><span style="color: #555555;">2</span><span>     1     2 Havixbecker … residen…    (4151491 3207923, 4151474 3207946) b    
#&gt; </span><span style="color: #555555;">3</span><span>     3     4 Pienersallee  seconda… (4151398 3207777, 4151390 3207727, 4… a    
#&gt; </span><span style="color: #555555;">4</span><span>     3     4 Pienersallee  seconda… (4151398 3207777, 4151390 3207727, 4… b    
#&gt; </span><span style="color: #555555;">5</span><span>     5     6 Schulte-Bern… residen… (4151408 3207539, 4151417 3207573, 4… a    
#&gt; </span><span style="color: #555555;">6</span><span>     5     6 Schulte-Bern… residen… (4151408 3207539, 4151417 3207573, 4… b    
#&gt; </span><span style="color: #555555;"># … with 983 more rows</span><span>
#&gt; </span><span style="color: #555555;">#
#&gt; # Node Data:     701 x 1</span><span>
#&gt; </span><span style="color: #555555;"># Geometry type: POINT</span><span>
#&gt; </span><span style="color: #555555;"># Dimension:     XY</span><span>
#&gt; </span><span style="color: #555555;"># Bounding box:  xmin: 4150707 ymin: 3206375 xmax: 4152367 ymax: 3208565</span><span>
#&gt;            geometry
#&gt;         </span><span style="color: #555555;font-style: italic;">&lt;POINT [m]&gt;</span><span>
#&gt; </span><span style="color: #555555;">1</span><span> (4151491 3207923)
#&gt; </span><span style="color: #555555;">2</span><span> (4151474 3207946)
#&gt; </span><span style="color: #555555;">3</span><span> (4151398 3207777)
#&gt; </span><span style="color: #555555;"># … with 698 more rows</span><span>
</span></code></pre>
<p>For non-spatial joins based on attribute columns, simply use a join function from <code>dplyr</code> (e.g. <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">dplyr::left_join()</a></code> or <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">dplyr::inner_join()</a></code>) instead of <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">sf::st_join()</a></code>.</p>
</div>
<div id="snapping-points-to-their-nearest-node-before-joining" class="section level3">
<h3 class="hasAnchor">
<a href="#snapping-points-to-their-nearest-node-before-joining" class="anchor"></a>Snapping points to their nearest node before joining</h3>
<p>Another network specific use-case of spatial joins would be to join information from external points of interest (POIs) into the nodes of the network. However, to do so, such points need to have <em>exactly</em> equal coordinates to one of the nodes. Often this will not be the case. To solve such situations, you will first need to update the coordinates of the POIs to match those of their <em>nearest node</em>. This process is also called <em>snapping</em>. To find the nearest node in the network for each POI, you can use the sf function <code><a href="https://r-spatial.github.io/sf/reference/st_nearest_feature.html">sf::st_nearest_feature()</a></code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">node1</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>
<span class="va">node2</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>
<span class="va">edge</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_linestring</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">node1</span>, <span class="va">node2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">net</span> <span class="op">=</span> <span class="fu"><a href="../reference/as_sfnetwork.html">as_sfnetwork</a></span><span class="op">(</span><span class="va">edge</span><span class="op">)</span>

<span class="va">pois</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>poi_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"bakery"</span>, <span class="st">"butcher"</span><span class="op">)</span>,
                  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.6</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Find indices of nearest nodes.</span>
<span class="va">nearest_nodes</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_nearest_feature.html">st_nearest_feature</a></span><span class="op">(</span><span class="va">pois</span>, <span class="va">net</span><span class="op">)</span>

<span class="co"># Replace geometries.</span>
<span class="va">snapped_pois</span> <span class="op">=</span> <span class="va">pois</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_set_geometry</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="va">net</span><span class="op">)</span><span class="op">[</span><span class="va">nearest_nodes</span><span class="op">]</span><span class="op">)</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">net</span>, cex <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">pois</span>, pch <span class="op">=</span> <span class="fl">8</span>, cex <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">2</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_nearest_points.html">st_nearest_points</a></span><span class="op">(</span><span class="va">pois</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span>, <span class="va">net</span><span class="op">)</span><span class="op">[</span><span class="va">nearest_nodes</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,
     col <span class="op">=</span> <span class="st">"grey"</span>, lty <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">2</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_nearest_points.html">st_nearest_points</a></span><span class="op">(</span><span class="va">pois</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span>, <span class="va">net</span><span class="op">)</span><span class="op">[</span><span class="va">nearest_nodes</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>,
     col <span class="op">=</span> <span class="st">"grey"</span>, lty <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">2</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">net</span>, cex <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">snapped_pois</span>, pch <span class="op">=</span> <span class="fl">8</span>, cex <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">2</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p><img src="join_filter_files/figure-html/unnamed-chunk-12-1.png" width="50%"><img src="join_filter_files/figure-html/unnamed-chunk-12-2.png" width="50%"></p>
<p>After snapping the POIs, we can use <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">sf::st_join()</a></code> as expected.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_join</a></span><span class="op">(</span><span class="va">net</span>, <span class="va">snapped_pois</span><span class="op">)</span></code></pre></div>
<pre class="fansi fansi-output"><code>#&gt; <span style="color: #555555;"># A sfnetwork with</span><span> </span><span style="color: #555555;">2</span><span> </span><span style="color: #555555;">nodes and</span><span> </span><span style="color: #555555;">1</span><span> </span><span style="color: #555555;">edges
#&gt; #
#&gt; # CRS: </span><span> </span><span style="color: #555555;">NA</span><span> </span><span style="color: #555555;">
#&gt; #
#&gt; # A rooted tree with spatially explicit edges
#&gt; #
#&gt; # Node Data:     2 x 2 (active)</span><span>
#&gt; </span><span style="color: #555555;"># Geometry type: POINT</span><span>
#&gt; </span><span style="color: #555555;"># Dimension:     XY</span><span>
#&gt; </span><span style="color: #555555;"># Bounding box:  xmin: 0 ymin: 0 xmax: 1 ymax: 0</span><span>
#&gt;         x poi_type
#&gt;   </span><span style="color: #555555;font-style: italic;">&lt;POINT&gt;</span><span> </span><span style="color: #555555;font-style: italic;">&lt;chr&gt;</span><span>   
#&gt; </span><span style="color: #555555;">1</span><span>   (0 0) bakery  
#&gt; </span><span style="color: #555555;">2</span><span>   (1 0) butcher 
#&gt; </span><span style="color: #555555;">#
#&gt; # Edge Data:     1 x 3</span><span>
#&gt; </span><span style="color: #555555;"># Geometry type: LINESTRING</span><span>
#&gt; </span><span style="color: #555555;"># Dimension:     XY</span><span>
#&gt; </span><span style="color: #555555;"># Bounding box:  xmin: 0 ymin: 0 xmax: 1 ymax: 0</span><span>
#&gt;    from    to            x
#&gt;   </span><span style="color: #555555;font-style: italic;">&lt;int&gt;</span><span> </span><span style="color: #555555;font-style: italic;">&lt;int&gt;</span><span> </span><span style="color: #555555;font-style: italic;">&lt;LINESTRING&gt;</span><span>
#&gt; </span><span style="color: #555555;">1</span><span>     1     2   (0 0, 1 0)
</span></code></pre>
</div>
<div id="blending-points-into-a-network" class="section level3">
<h3 class="hasAnchor">
<a href="#blending-points-into-a-network" class="anchor"></a>Blending points into a network</h3>
<p>In the example above, it makes sense to include the information from the first POI in an already existing node. For the second POI, however, its <em>nearest node</em> is quite far away relative to the <em>nearest location</em> on its <em>nearest edge</em>. In that case, you might want to split the edge at that location, and add a <em>new node</em> to the network. For this combination process we use the metaphor of throwing the network and POIs together in a blender, and mix them smoothly together.</p>
<p>The function <code><a href="../reference/st_network_blend.html">st_network_blend()</a></code> does exactly that. For each POI, it finds the nearest location <span class="math inline">\(p\)</span> on the nearest edge <span class="math inline">\(e\)</span>. If <span class="math inline">\(p\)</span> is an already existing node (i.e. <span class="math inline">\(p\)</span> is an endpoint of <span class="math inline">\(e\)</span>), it joins the information from the POI into that node. If <span class="math inline">\(p\)</span> is <em>not</em> an already existing node, it subdivides <span class="math inline">\(e\)</span> at <span class="math inline">\(p\)</span>, adds <span class="math inline">\(p\)</span> as a <em>new node</em> to the network, and joins the information from the POI into that new node. For this process, it does <em>not</em> matter if <span class="math inline">\(p\)</span> is an interior point in the linestring geometry of <span class="math inline">\(e\)</span>.</p>
<p><em>NOTE: This function is still experimental. It needs more testing and may be slow on large networks</em></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">blended</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_network_blend.html">st_network_blend</a></span><span class="op">(</span><span class="va">net</span>, <span class="va">pois</span><span class="op">)</span>
<span class="co">#&gt; Warning: st_network_blend assumes attributes are constant over geometries</span>
<span class="va">blended</span></code></pre></div>
<pre class="fansi fansi-output"><code>#&gt; <span style="color: #555555;"># A sfnetwork with</span><span> </span><span style="color: #555555;">3</span><span> </span><span style="color: #555555;">nodes and</span><span> </span><span style="color: #555555;">2</span><span> </span><span style="color: #555555;">edges
#&gt; #
#&gt; # CRS: </span><span> </span><span style="color: #555555;">NA</span><span> </span><span style="color: #555555;">
#&gt; #
#&gt; # A rooted tree with spatially explicit edges
#&gt; #
#&gt; # Node Data:     3 x 2 (active)</span><span>
#&gt; </span><span style="color: #555555;"># Geometry type: POINT</span><span>
#&gt; </span><span style="color: #555555;"># Dimension:     XY</span><span>
#&gt; </span><span style="color: #555555;"># Bounding box:  xmin: 0 ymin: 0 xmax: 1 ymax: 0</span><span>
#&gt;         x poi_type
#&gt;   </span><span style="color: #555555;font-style: italic;">&lt;POINT&gt;</span><span> </span><span style="color: #555555;font-style: italic;">&lt;chr&gt;</span><span>   
#&gt; </span><span style="color: #555555;">1</span><span>   (0 0) bakery  
#&gt; </span><span style="color: #555555;">2</span><span> (0.6 0) butcher 
#&gt; </span><span style="color: #555555;">3</span><span>   (1 0) </span><span style="color: #BB0000;">NA</span><span>      
#&gt; </span><span style="color: #555555;">#
#&gt; # Edge Data:     2 x 3</span><span>
#&gt; </span><span style="color: #555555;"># Geometry type: LINESTRING</span><span>
#&gt; </span><span style="color: #555555;"># Dimension:     XY</span><span>
#&gt; </span><span style="color: #555555;"># Bounding box:  xmin: 0 ymin: 0 xmax: 1 ymax: 0</span><span>
#&gt;    from    to            x
#&gt;   </span><span style="color: #555555;font-style: italic;">&lt;int&gt;</span><span> </span><span style="color: #555555;font-style: italic;">&lt;int&gt;</span><span> </span><span style="color: #555555;font-style: italic;">&lt;LINESTRING&gt;</span><span>
#&gt; </span><span style="color: #555555;">1</span><span>     1     2 (0 0, 0.6 0)
#&gt; </span><span style="color: #555555;">2</span><span>     2     3 (0.6 0, 1 0)
</span></code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">net</span>, cex <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">pois</span>, pch <span class="op">=</span> <span class="fl">8</span>, cex <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">2</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_nearest_points.html">st_nearest_points</a></span><span class="op">(</span><span class="va">pois</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span>, <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html">activate</a></span><span class="op">(</span><span class="va">net</span>, <span class="st">"edges"</span><span class="op">)</span><span class="op">)</span>,
     col <span class="op">=</span> <span class="st">"grey"</span>, lty <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">2</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_nearest_points.html">st_nearest_points</a></span><span class="op">(</span><span class="va">pois</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span>, <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html">activate</a></span><span class="op">(</span><span class="va">net</span>, <span class="st">"edges"</span><span class="op">)</span><span class="op">)</span>,
     col <span class="op">=</span> <span class="st">"grey"</span>, lty <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">2</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">blended</span>, cex <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></code></pre></div>
<p><img src="join_filter_files/figure-html/unnamed-chunk-14-1.png" width="50%"><img src="join_filter_files/figure-html/unnamed-chunk-14-2.png" width="50%"></p>
</div>
<div id="joining-two-networks" class="section level3">
<h3 class="hasAnchor">
<a href="#joining-two-networks" class="anchor"></a>Joining two networks</h3>
<p>In the examples above it was all about joining information from external features into a network. But how about joining two networks? This is what the <code><a href="../reference/st_network_join.html">st_network_join()</a></code> function is for. It takes two sfnetworks as input and makes a spatial full join on the geometries of the nodes data, based on the <em>equals</em> spatial predicate. That means, all nodes from network x <em>and</em> all nodes from network y are present in the joined network, but if there were nodes in x with equal geometries to nodes in y, these nodes become a <em>single node</em> in the joined network. Edge data are combined using a <code><a href="https://dplyr.tidyverse.org/reference/bind.html">dplyr::bind_rows()</a></code> semantic, meaning that data are matched by column name and values are filled with <code>NA</code> if missing in either of the networks. The <em>from</em> and <em>to</em> columns in the edge data are updated automatically such that they correctly match the new node indices of the joined network. There is no spatial join performed on the edges. Hence, if there is an edge in x with an equal geometry to an edge in y, they remain separate edges in the joined network.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">node3</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">node4</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">edge2</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_linestring</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">node2</span>, <span class="va">node3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">edge3</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_linestring</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">node3</span>, <span class="va">node4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">net</span> <span class="op">=</span> <span class="fu"><a href="../reference/as_sfnetwork.html">as_sfnetwork</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">edge</span>, <span class="va">edge2</span><span class="op">)</span><span class="op">)</span>
<span class="va">other_net</span> <span class="op">=</span> <span class="fu"><a href="../reference/as_sfnetwork.html">as_sfnetwork</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">edge2</span>, <span class="va">edge3</span><span class="op">)</span><span class="op">)</span>

<span class="va">joined</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_network_join.html">st_network_join</a></span><span class="op">(</span><span class="va">net</span>, <span class="va">other_net</span><span class="op">)</span>
<span class="va">joined</span></code></pre></div>
<pre class="fansi fansi-output"><code>#&gt; <span style="color: #555555;"># A sfnetwork with</span><span> </span><span style="color: #555555;">4</span><span> </span><span style="color: #555555;">nodes and</span><span> </span><span style="color: #555555;">4</span><span> </span><span style="color: #555555;">edges
#&gt; #
#&gt; # CRS: </span><span> </span><span style="color: #555555;">NA</span><span> </span><span style="color: #555555;">
#&gt; #
#&gt; # A directed acyclic multigraph with 1 component with spatially explicit edges
#&gt; #
#&gt; # Node Data:     4 x 1 (active)</span><span>
#&gt; </span><span style="color: #555555;"># Geometry type: POINT</span><span>
#&gt; </span><span style="color: #555555;"># Dimension:     XY</span><span>
#&gt; </span><span style="color: #555555;"># Bounding box:  xmin: 0 ymin: 0 xmax: 1 ymax: 1</span><span>
#&gt;         x
#&gt;   </span><span style="color: #555555;font-style: italic;">&lt;POINT&gt;</span><span>
#&gt; </span><span style="color: #555555;">1</span><span>   (0 0)
#&gt; </span><span style="color: #555555;">2</span><span>   (1 0)
#&gt; </span><span style="color: #555555;">3</span><span>   (1 1)
#&gt; </span><span style="color: #555555;">4</span><span>   (0 1)
#&gt; </span><span style="color: #555555;">#
#&gt; # Edge Data:     4 x 3</span><span>
#&gt; </span><span style="color: #555555;"># Geometry type: LINESTRING</span><span>
#&gt; </span><span style="color: #555555;"># Dimension:     XY</span><span>
#&gt; </span><span style="color: #555555;"># Bounding box:  xmin: 0 ymin: 0 xmax: 1 ymax: 1</span><span>
#&gt;    from    to            x
#&gt;   </span><span style="color: #555555;font-style: italic;">&lt;int&gt;</span><span> </span><span style="color: #555555;font-style: italic;">&lt;int&gt;</span><span> </span><span style="color: #555555;font-style: italic;">&lt;LINESTRING&gt;</span><span>
#&gt; </span><span style="color: #555555;">1</span><span>     1     2   (0 0, 1 0)
#&gt; </span><span style="color: #555555;">2</span><span>     2     3   (1 0, 1 1)
#&gt; </span><span style="color: #555555;">3</span><span>     2     3   (1 0, 1 1)
#&gt; </span><span style="color: #555555;"># … with 1 more row</span><span>
</span></code></pre>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">net</span>, pch <span class="op">=</span> <span class="fl">15</span>, cex <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">other_net</span>, col <span class="op">=</span> <span class="st">"red"</span>, pch <span class="op">=</span> <span class="fl">18</span>, cex <span class="op">=</span> <span class="fl">2</span>, lty <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">4</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">joined</span>, cex <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></code></pre></div>
<p><img src="join_filter_files/figure-html/unnamed-chunk-15-1.png" width="50%"><img src="join_filter_files/figure-html/unnamed-chunk-15-2.png" width="50%"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Lucas van der Meer, Lorena Abad, Andrea Gilardi, Robin Lovelace.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
