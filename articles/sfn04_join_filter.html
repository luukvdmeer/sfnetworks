<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Spatial joins and filters • sfnetworks</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="sfn04_join_filter_files/libs/quarto-html/popper.min.js"></script><script src="sfn04_join_filter_files/libs/quarto-html/tippy.umd.min.js"></script><link href="sfn04_join_filter_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="sfn04_join_filter_files/libs/quarto-html/light-border.css" rel="stylesheet">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Spatial joins and filters">
<meta property="og:image" content="https://luukvdmeer.github.io/sfnetworks/logo.png">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">sfnetworks</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/sfn01_intro.html">Introduction to sfnetworks</a></li>
    <li><a class="dropdown-item" href="../articles/sfn02_create_represent.html">Creating and representing spatial networks</a></li>
    <li><a class="dropdown-item" href="../articles/sfn03_cleaning.html">Cleaning spatial networks</a></li>
    <li><a class="dropdown-item" href="../articles/sfn04_join_filter.html">Spatial joins and filters</a></li>
    <li><a class="dropdown-item" href="../articles/sfn05_routing.html">Routing on spatial networks</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/luukvdmeer/sfnetworks/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-quarto">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Spatial joins and filters</h1>


      <p class="date">2024-11-17</p>

      <small class="dont-index">Source: <a href="https://github.com/luukvdmeer/sfnetworks/blob/main/vignettes/sfn04_join_filter.qmd" class="external-link"><code>vignettes/sfn04_join_filter.qmd</code></a></small>
      <div class="d-none name"><code></code></div>
    </div>






    <style type="text/css" scoped="">
PRE.fansi SPAN {padding-top: .25em; padding-bottom: .25em};
</style>
<p>The integration with <a href="https://r-spatial.github.io/sf/" class="external-link">sf</a> and addition of several spatial network specific functions in <code>sfnetworks</code> allow to easily filter information from a network based on spatial relationships, and to join new information into a network based on spatial relationships. This vignette presents several ways to do that.</p>
<p>Both spatial filters and spatial joins use spatial predicate functions to examine spatial relationships. Spatial predicates are mathematically defined binary spatial relations between two simple feature geometries. Often used examples include the predicate <em>equals</em> (geometry x is equal to geometry y) and the predicate <em>intersects</em> (geometry x has at least one point in common with geometry y). For an overview of all available spatial predicate functions in <a href="https://r-spatial.github.io/sf/" class="external-link">sf</a> and links to detailed explanations of the underlying algorithms, see <a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html" class="external-link">here</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://luukvdmeer.github.io/sfnetworks/">sfnetworks</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidygraph.data-imaginist.com" class="external-link">tidygraph</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggraph.data-imaginist.com" class="external-link">ggraph</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span></code></pre></div>
</div>
<section class="level2"><h2 id="spatial-filters">Spatial filters<a class="anchor" aria-label="anchor" href="#spatial-filters"></a>
</h2>
<section class="level3"><h3 id="using-st_filter">Using st_filter<a class="anchor" aria-label="anchor" href="#using-st_filter"></a>
</h3>
<p>Information can be filtered from a network by using spatial predicate functions inside the sf function <code><a href="https://r-spatial.github.io/sf/reference/st_join.html" class="external-link">sf::st_filter()</a></code>, which works as follows: the function is applied to a set of geometries A with respect to another set of geometries B, and removes features from A based on their spatial relation with the features in B. A practical example: when using the predicate <em>intersects</em>, all geometries in A that do not intersect with any geometry in B are removed.</p>
<p>When applying <code><a href="https://r-spatial.github.io/sf/reference/st_join.html" class="external-link">sf::st_filter()</a></code> to a sfnetwork, it is internally applied to the active element of that network. For example: filtering information from a network A with activated nodes, using a set of polygons B and the predicate <em>intersects</em>, will remove those nodes that do not intersect with any of the polygons in B from the network. When edges are active, it will remove the edges that do not intersect with any of the polygons in B from the network.</p>
<p>Although the filter is applied only to the active element of the network, it may also affect the other element. When nodes are removed, their incident edges are removed as well. However, when edges are removed, the nodes at their endpoints remain, even if they don’t have any other incident edges. This behavior is inherited from <a href="https://tidygraph.data-imaginist.com" class="external-link">tidygraph</a> and understandable from a graph theory point of view: by definition nodes can exist peacefully in isolation, while edges can never exist without nodes at their endpoints. The isolated nodes that remain after filtering the edges can be easily removed using a combination of a regular <code><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">dplyr::filter()</a></code> verb and the <code><a href="https://tidygraph.data-imaginist.com/reference/node_types.html" class="external-link">tidygraph::node_is_isolated()</a></code> query function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">net</span> <span class="op">=</span> <span class="fu"><a href="../reference/as_sfnetwork.html">as_sfnetwork</a></span><span class="op">(</span><span class="va">mozart</span>, <span class="st">"gabriel"</span><span class="op">)</span></span>
<span><span class="va">ply</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_buffer</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_centroid</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_combine</a></span><span class="op">(</span><span class="va">mozart</span><span class="op">)</span><span class="op">)</span>, <span class="fl">300</span><span class="op">)</span></span>
<span></span>
<span><span class="va">filtered_by_nodes</span> <span class="op">=</span> <span class="va">net</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html" class="external-link">st_filter</a></span><span class="op">(</span><span class="va">ply</span>, .pred <span class="op">=</span> <span class="va">st_intersects</span><span class="op">)</span></span>
<span></span>
<span><span class="va">filtered_by_edges_a</span> <span class="op">=</span> <span class="va">net</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html" class="external-link">activate</a></span><span class="op">(</span><span class="va">edges</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html" class="external-link">st_filter</a></span><span class="op">(</span><span class="va">ply</span>, .pred <span class="op">=</span> <span class="va">st_intersects</span><span class="op">)</span></span>
<span></span>
<span><span class="va">filtered_by_edges_b</span> <span class="op">=</span> <span class="va">net</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html" class="external-link">activate</a></span><span class="op">(</span><span class="va">edges</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html" class="external-link">st_filter</a></span><span class="op">(</span><span class="va">ply</span>, .pred <span class="op">=</span> <span class="va">st_intersects</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html" class="external-link">activate</a></span><span class="op">(</span><span class="va">nodes</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/node_types.html" class="external-link">node_is_isolated</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggraph.data-imaginist.com/reference/ggraph.html" class="external-link">ggraph</a></span><span class="op">(</span><span class="va">net</span>, <span class="st">"sf"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_edge_sf.html" class="external-link">geom_edge_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_sf.html" class="external-link">geom_node_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ply</span>, color <span class="op">=</span> <span class="st">"orange"</span>, fill <span class="op">=</span> <span class="cn">NA</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggraph.data-imaginist.com/reference/ggraph.html" class="external-link">ggraph</a></span><span class="op">(</span><span class="va">filtered_by_nodes</span>, <span class="st">"sf"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_edge_sf.html" class="external-link">geom_edge_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_sf.html" class="external-link">geom_node_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ply</span>, color <span class="op">=</span> <span class="st">"orange"</span>, fill <span class="op">=</span> <span class="cn">NA</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggraph.data-imaginist.com/reference/ggraph.html" class="external-link">ggraph</a></span><span class="op">(</span><span class="va">filtered_by_edges_a</span>, <span class="st">"sf"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_edge_sf.html" class="external-link">geom_edge_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_sf.html" class="external-link">geom_node_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ply</span>, color <span class="op">=</span> <span class="st">"orange"</span>, fill <span class="op">=</span> <span class="cn">NA</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggraph.data-imaginist.com/reference/ggraph.html" class="external-link">ggraph</a></span><span class="op">(</span><span class="va">filtered_by_edges_b</span>, <span class="st">"sf"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_edge_sf.html" class="external-link">geom_edge_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_sf.html" class="external-link">geom_node_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ply</span>, color <span class="op">=</span> <span class="st">"orange"</span>, fill <span class="op">=</span> <span class="cn">NA</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell quarto-layout-panel" data-layout-nrow="2" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="sfn04_join_filter_files/figure-html/unnamed-chunk-5-1.png" width="672"></p>
<figcaption>Original network</figcaption></figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="sfn04_join_filter_files/figure-html/unnamed-chunk-5-2.png" width="672"></p>
<figcaption>Filtered by nodes</figcaption></figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="sfn04_join_filter_files/figure-html/unnamed-chunk-5-3.png" width="672"></p>
<figcaption>Filtered by edges</figcaption></figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="sfn04_join_filter_files/figure-html/unnamed-chunk-5-4.png" width="672"></p>
<figcaption>Removed isolated nodes</figcaption></figure>
</div>
</div>
</div>
</div>
<p>For non-spatial filters applied to attribute columns, simply use <code><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">dplyr::filter()</a></code> instead of <code><a href="https://r-spatial.github.io/sf/reference/st_join.html" class="external-link">sf::st_filter()</a></code>.</p>
</section><section class="level3"><h3 id="using-spatial-node-and-edge-query-functions">Using spatial node and edge query functions<a class="anchor" aria-label="anchor" href="#using-spatial-node-and-edge-query-functions"></a>
</h3>
<p>In <a href="https://tidygraph.data-imaginist.com" class="external-link">tidygraph</a>, filtering information from networks is done by using specific node or edge query functions inside the <code><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">dplyr::filter()</a></code> verb. An example was already shown above, where isolated nodes were removed from the network.</p>
<p>In <a href="https://luukvdmeer.github.io/sfnetworks/">sfnetworks</a>, several spatial predicates are implemented as node and edge query functions such that you can also do spatial filtering in tidygraph style. See <a href="https://luukvdmeer.github.io/sfnetworks/reference/spatial_node_predicates.html">here</a> for a list of all implemented spatial node query functions, and <a href="https://luukvdmeer.github.io/sfnetworks/reference/spatial_edge_predicates.html">here</a> for the spatial edge query functions. Using them makes spatial filter operations fit better into the tidy workflows of <a href="https://tidygraph.data-imaginist.com" class="external-link">tidygraph</a>. For example, we could filter edges that do not cross any other edge. The <code><a href="https://tidygraph.data-imaginist.com/reference/context_accessors.html" class="external-link">tidygraph::.E()</a></code> function used in the example makes it possible to directly access the complete edges table inside verbs. Similarly, we can use <code><a href="https://tidygraph.data-imaginist.com/reference/context_accessors.html" class="external-link">tidygraph::.N()</a></code> to access the nodes table and <code><a href="https://tidygraph.data-imaginist.com/reference/context_accessors.html" class="external-link">tidygraph::.G()</a></code> to access the network object as a whole.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">complete_net</span> <span class="op">=</span> <span class="fu"><a href="../reference/as_sfnetwork.html">as_sfnetwork</a></span><span class="op">(</span><span class="va">mozart</span>, <span class="st">"complete"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">filtered</span> <span class="op">=</span> <span class="va">complete_net</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html" class="external-link">activate</a></span><span class="op">(</span><span class="va">edges</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="../reference/spatial_edge_predicates.html">edge_crosses</a></span><span class="op">(</span><span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/context_accessors.html" class="external-link">.E</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html" class="external-link">activate</a></span><span class="op">(</span><span class="va">nodes</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/node_types.html" class="external-link">node_is_isolated</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggraph.data-imaginist.com/reference/ggraph.html" class="external-link">ggraph</a></span><span class="op">(</span><span class="va">complete_net</span>, <span class="st">"sf"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_edge_sf.html" class="external-link">geom_edge_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_sf.html" class="external-link">geom_node_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggraph.data-imaginist.com/reference/ggraph.html" class="external-link">ggraph</a></span><span class="op">(</span><span class="va">filtered</span>, <span class="st">"sf"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_edge_sf.html" class="external-link">geom_edge_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_sf.html" class="external-link">geom_node_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="sfn04_join_filter_files/figure-html/unnamed-chunk-7-1.png" width="672"></p>
<figcaption>Original network</figcaption></figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="sfn04_join_filter_files/figure-html/unnamed-chunk-7-2.png" width="672"></p>
<figcaption>Filtered network</figcaption></figure>
</div>
</div>
</div>
</div>
<p>Besides predicate query functions, you can also use the <a href="https://luukvdmeer.github.io/sfnetworks/reference/node_coordinates.html">coordinate query functions</a> for spatial filters on the nodes. For example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">=</span> <span class="fl">4549358</span></span>
<span></span>
<span><span class="va">filtered_by_coords</span> <span class="op">=</span> <span class="va">net</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="../reference/node_coordinates.html">node_X</a></span><span class="op">(</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">x</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggraph.data-imaginist.com/reference/ggraph.html" class="external-link">ggraph</a></span><span class="op">(</span><span class="va">net</span>, <span class="st">"sf"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_edge_sf.html" class="external-link">geom_edge_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_sf.html" class="external-link">geom_node_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">x</span>, linewidth <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="st">"orange"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggraph.data-imaginist.com/reference/ggraph.html" class="external-link">ggraph</a></span><span class="op">(</span><span class="va">filtered_by_coords</span>, <span class="st">"sf"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_edge_sf.html" class="external-link">geom_edge_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_sf.html" class="external-link">geom_node_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">x</span>, linewidth <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="st">"orange"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="sfn04_join_filter_files/figure-html/unnamed-chunk-9-1.png" width="672"></p>
<figcaption>Original network</figcaption></figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="sfn04_join_filter_files/figure-html/unnamed-chunk-9-2.png" width="672"></p>
<figcaption>Filtered network</figcaption></figure>
</div>
</div>
</div>
</div>
</section><section class="level3"><h3 id="clipping">Clipping<a class="anchor" aria-label="anchor" href="#clipping"></a>
</h3>
<p>Filtering returns a subset of the original geometries, but leaves those geometries themselves unchanged. This is different from clipping, in which they get cut at the border of a provided clip feature. There are three ways in which you can do this: <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html" class="external-link">sf::st_intersection()</a></code> keeps only those parts of the original geometries that lie within the clip feature, <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html" class="external-link">sf::st_difference()</a></code> keeps only those parts of the original geometries that lie outside the clip feature, and <code><a href="https://r-spatial.github.io/sf/reference/st_crop.html" class="external-link">sf::st_crop()</a></code> keeps only those parts of the original geometries that lie within the bounding box of the clip feature.</p>
<p>Note that in the case of the nodes, clipping is not different from filtering, since point geometries cannot fall party inside and partly outside another feature. However, in the case of the edges, clipping will cut the linestring geometries of the edges at the border of the clip feature (or in the case of cropping, the bounding box of that feature). To preserve a valid spatial network structure, <a href="https://luukvdmeer.github.io/sfnetworks/">sfnetworks</a> adds new nodes at these cut locations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clipped</span> <span class="op">=</span> <span class="va">net</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html" class="external-link">activate</a></span><span class="op">(</span><span class="va">edges</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html" class="external-link">st_intersection</a></span><span class="op">(</span><span class="va">ply</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html" class="external-link">activate</a></span><span class="op">(</span><span class="va">nodes</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/node_types.html" class="external-link">node_is_isolated</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: attribute variables are assumed to be spatially constant throughout</span></span>
<span><span class="co">#&gt; all geometries</span></span></code></pre></div>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggraph.data-imaginist.com/reference/ggraph.html" class="external-link">ggraph</a></span><span class="op">(</span><span class="va">net</span>, <span class="st">"sf"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_edge_sf.html" class="external-link">geom_edge_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_sf.html" class="external-link">geom_node_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ply</span>, color <span class="op">=</span> <span class="st">"orange"</span>, fill <span class="op">=</span> <span class="cn">NA</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggraph.data-imaginist.com/reference/ggraph.html" class="external-link">ggraph</a></span><span class="op">(</span><span class="va">filtered_by_edges_b</span>, <span class="st">"sf"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_edge_sf.html" class="external-link">geom_edge_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_sf.html" class="external-link">geom_node_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ply</span>, color <span class="op">=</span> <span class="st">"orange"</span>, fill <span class="op">=</span> <span class="cn">NA</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggraph.data-imaginist.com/reference/ggraph.html" class="external-link">ggraph</a></span><span class="op">(</span><span class="va">clipped</span>, <span class="st">"sf"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_edge_sf.html" class="external-link">geom_edge_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_sf.html" class="external-link">geom_node_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ply</span>, color <span class="op">=</span> <span class="st">"orange"</span>, fill <span class="op">=</span> <span class="cn">NA</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell quarto-layout-panel" data-layout-ncol="3">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="sfn04_join_filter_files/figure-html/unnamed-chunk-11-1.png" width="672"></p>
<figcaption>Original network</figcaption></figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="sfn04_join_filter_files/figure-html/unnamed-chunk-11-2.png" width="672"></p>
<figcaption>Filtered</figcaption></figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="sfn04_join_filter_files/figure-html/unnamed-chunk-11-3.png" width="672"></p>
<figcaption>Clipped</figcaption></figure>
</div>
</div>
</div>
</div>
</section></section><section class="level2"><h2 id="spatial-joins">Spatial joins<a class="anchor" aria-label="anchor" href="#spatial-joins"></a>
</h2>
<section class="level3"><h3 id="using-st_join">Using st_join<a class="anchor" aria-label="anchor" href="#using-st_join"></a>
</h3>
<p>Information can be spatially joined into a network by using spatial predicate functions inside the sf function <code><a href="https://r-spatial.github.io/sf/reference/st_join.html" class="external-link">sf::st_join()</a></code>, which works as follows: the function is applied to a set of geometries A with respect to another set of geometries B, and attaches feature attributes from features in B to features in A based on their spatial relation. A practical example: when using the predicate <em>intersects</em>, feature attributes from feature y in B are attached to feature x in A whenever x intersects with y.</p>
<p>When applying <code><a href="https://r-spatial.github.io/sf/reference/st_join.html" class="external-link">sf::st_join()</a></code> to a <code>sfnetwork</code> object, it is internally applied to the active element of that network. For example: joining information into network A with activated nodes, from a set of polygons B and using the predicate <em>intersects</em>, will attach attributes from a polygon in B to those nodes that intersect with that specific polygon. When edges are active, it will attach the same information but to the intersecting edges instead.</p>
<p>Lets show this with an example in which we first create imaginary postal code areas for the Mozart dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">codes</span> <span class="op">=</span> <span class="va">net</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_make_grid.html" class="external-link">st_make_grid</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>code <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">1000</span> <span class="op">+</span> <span class="fu"><a href="../reference/n.html">n</a></span><span class="op">(</span><span class="op">)</span> <span class="op">*</span> <span class="fl">10</span> <span class="op">-</span> <span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">joined</span> <span class="op">=</span> <span class="va">net</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html" class="external-link">st_join</a></span><span class="op">(</span><span class="va">codes</span>, join <span class="op">=</span> <span class="va">st_intersects</span><span class="op">)</span></span>
<span></span>
<span><span class="va">joined</span></span></code></pre></div>
<pre class="fansi fansi-output"><code><span><span class="co">#&gt; # A sfnetwork: 17 nodes and 50 edges</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # A bipartite simple graph with 1 component and spatially explicit edges</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # Dimension: XY</span></span>
<span><span class="co">#&gt; # Bounding box: xmin: 4548664 ymin: 2747309 xmax: 4549589 ymax: 2748537</span></span>
<span><span class="co">#&gt; # Projected CRS: ETRS89-extended / LAEA Europe</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # Node data: 17 × 5 (active)</span></span>
<span><span class="co">#&gt;   name                  type     website                  geometry code</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;                 &lt;chr&gt;    &lt;chr&gt;                 &lt;POINT [m]&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1 Mozartkino            cinema   https://www.mo… (4549504 2747309) 1010</span></span>
<span><span class="co">#&gt; 2 Haus für Mozart       theatre  NA              (4549003 2747376) 1000</span></span>
<span><span class="co">#&gt; 3 Mozartsteg/Rudolfskai bus_stop NA              (4549589 2747507) 1010</span></span>
<span><span class="co">#&gt; 4 Mozart Denkmal        artwork  NA              (4549387 2747514) 1010</span></span>
<span><span class="co">#&gt; 5 Mozartsteg/Rudolfskai bus_stop NA              (4549491 2747551) 1010</span></span>
<span><span class="co">#&gt; 6 Mozartsteg            bridge   NA              (4549473 2747624) 1010</span></span>
<span><span class="co">#&gt; # ℹ 11 more rows</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # Edge data: 50 × 3</span></span>
<span><span class="co">#&gt;    from    to                           geometry</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt;                   &lt;LINESTRING [m]&gt;</span></span>
<span><span class="co">#&gt; 1     1     3 (4549504 2747309, 4549589 2747507)</span></span>
<span><span class="co">#&gt; 2     1     4 (4549504 2747309, 4549387 2747514)</span></span>
<span><span class="co">#&gt; 3     2     4 (4549003 2747376, 4549387 2747514)</span></span>
<span><span class="co">#&gt; # ℹ 47 more rows</span></span></code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggraph.data-imaginist.com/reference/ggraph.html" class="external-link">ggraph</a></span><span class="op">(</span><span class="va">net</span>, <span class="st">"sf"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">codes</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">code</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_edge_sf.html" class="external-link">geom_edge_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_sf.html" class="external-link">geom_node_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggraph.data-imaginist.com/reference/ggraph.html" class="external-link">ggraph</a></span><span class="op">(</span><span class="va">joined</span>, <span class="st">"sf"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_edge_sf.html" class="external-link">geom_edge_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_sf.html" class="external-link">geom_node_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">code</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="sfn04_join_filter_files/figure-html/unnamed-chunk-13-1.png" width="672"></p>
<figcaption>Original network and postal codes</figcaption></figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="sfn04_join_filter_files/figure-html/unnamed-chunk-13-2.png" width="672"></p>
<figcaption>Network with joined information</figcaption></figure>
</div>
</div>
</div>
</div>
<p>In the example above, the polygons are spatially distinct. Hence, each node can only intersect with a single polygon. But what would happen if we do a join with polygons that overlap? The attributes from which polygon will then be attached to a node that intersects with multiple polygons at once? In <a href="https://r-spatial.github.io/sf/" class="external-link">sf</a> this issue is solved by duplicating such a point as much times as the number of polygons it intersects with, and attaching attributes of each intersecting polygon to one of these duplicates. This approach does not fit the network case, however. An edge can only have a single node at each of its endpoints, and thus, the duplicated nodes will be isolated and redundant in the network structure. Therefore, <a href="https://luukvdmeer.github.io/sfnetworks/">sfnetworks</a> will only join the information from the first match whenever there are multiple matches for a single node. A warning is given in that case such that you are aware of the fact that not all information was joined into the network.</p>
<p>Only when you set <code>ignore_multiple = FALSE</code>, multiple matches will result in duplicated nodes, but these duplicates are isolated (i.e. not connected to the rest of the network). You can then use the morpher <code><a href="../reference/spatial_morphers.html">to_spatial_unique()</a></code> to merge spatially duplicated nodes into one, specifying how their attributes should be combined. See <a href="https://luukvdmeer.github.io/sfnetworks/articles/sfn03_cleaning.html/#merge-nodes-at-equal-locations">here</a> for an example.</p>
<p>Note that in the case of joining on the edges, multiple matches per edge are not a problem for the network structure. It will simply duplicate the edge (i.e. creating a set of parallel edges) whenever this occurs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">box</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html" class="external-link">st_as_sfc</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="va">mozart</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">two_equal_polys</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">box</span>, <span class="va">box</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>foo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Join on nodes gives a warning that only the first match per node is joined.</span></span>
<span><span class="co"># The number of nodes in the resulting network remains the same.</span></span>
<span><span class="va">net</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html" class="external-link">st_join</a></span><span class="op">(</span><span class="va">two_equal_polys</span>, join <span class="op">=</span> <span class="va">st_intersects</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: [1m[22m`st_join()` did not join all features.</span></span>
<span><span class="co">#&gt; [33m![39m Multiple matches were detected for some nodes, of which all but the first one</span></span>
<span><span class="co">#&gt;   are ignored.</span></span>
<span><span class="co">#&gt; [36mℹ[39m If you want to add multiple matches as isolated nodes instead, set</span></span>
<span><span class="co">#&gt;   `ignore_multiple` to `FALSE`.</span></span></code></pre></div>
<pre class="fansi fansi-output"><code><span><span class="co">#&gt; # A sfnetwork: 17 nodes and 50 edges</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # A bipartite simple graph with 1 component and spatially explicit edges</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # Dimension: XY</span></span>
<span><span class="co">#&gt; # Bounding box: xmin: 4548664 ymin: 2747309 xmax: 4549589 ymax: 2748537</span></span>
<span><span class="co">#&gt; # Projected CRS: ETRS89-extended / LAEA Europe</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # Node data: 17 × 5 (active)</span></span>
<span><span class="co">#&gt;   name                  type     website                  geometry foo</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;                 &lt;chr&gt;    &lt;chr&gt;                 &lt;POINT [m]&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1 Mozartkino            cinema   https://www.mo… (4549504 2747309) a</span></span>
<span><span class="co">#&gt; 2 Haus für Mozart       theatre  NA              (4549003 2747376) a</span></span>
<span><span class="co">#&gt; 3 Mozartsteg/Rudolfskai bus_stop NA              (4549589 2747507) a</span></span>
<span><span class="co">#&gt; 4 Mozart Denkmal        artwork  NA              (4549387 2747514) a</span></span>
<span><span class="co">#&gt; 5 Mozartsteg/Rudolfskai bus_stop NA              (4549491 2747551) a</span></span>
<span><span class="co">#&gt; 6 Mozartsteg            bridge   NA              (4549473 2747624) a</span></span>
<span><span class="co">#&gt; # ℹ 11 more rows</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # Edge data: 50 × 3</span></span>
<span><span class="co">#&gt;    from    to                           geometry</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt;                   &lt;LINESTRING [m]&gt;</span></span>
<span><span class="co">#&gt; 1     1     3 (4549504 2747309, 4549589 2747507)</span></span>
<span><span class="co">#&gt; 2     1     4 (4549504 2747309, 4549387 2747514)</span></span>
<span><span class="co">#&gt; 3     2     4 (4549003 2747376, 4549387 2747514)</span></span>
<span><span class="co">#&gt; # ℹ 47 more rows</span></span></code></pre>
<div class="sourceCode cell-code" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># With these settings multiple matches result in duplicated nodes.</span></span>
<span><span class="co"># In this example it means we have twice the number of nodes than before.</span></span>
<span><span class="co"># The duplicated nodes are isolated, i.e. not connected to any other node.</span></span>
<span><span class="va">net</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html" class="external-link">st_join</a></span><span class="op">(</span><span class="va">two_equal_polys</span>, join <span class="op">=</span> <span class="va">st_intersects</span>, ignore_multiple <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: [1m[22m`st_join()` created isolated nodes.</span></span>
<span><span class="co">#&gt; [33m![39m Multiple matches were detected for some nodes, of which all but the first one</span></span>
<span><span class="co">#&gt;   are added as isolated nodes to the network.</span></span>
<span><span class="co">#&gt; [36mℹ[39m If you want to ignore multiple matches instead, set `ignore_multiple` to</span></span>
<span><span class="co">#&gt;   `TRUE`.</span></span></code></pre></div>
<pre class="fansi fansi-output"><code><span><span class="co">#&gt; # A sfnetwork: 34 nodes and 50 edges</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # A bipartite simple graph with 18 components and spatially explicit edges</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # Dimension: XY</span></span>
<span><span class="co">#&gt; # Bounding box: xmin: 4548664 ymin: 2747309 xmax: 4549589 ymax: 2748537</span></span>
<span><span class="co">#&gt; # Projected CRS: ETRS89-extended / LAEA Europe</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # Node data: 34 × 5 (active)</span></span>
<span><span class="co">#&gt;   name                  type     website         foo            geometry</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;                 &lt;chr&gt;    &lt;chr&gt;           &lt;chr&gt;       &lt;POINT [m]&gt;</span></span>
<span><span class="co">#&gt; 1 Mozartkino            cinema   https://www.mo… a     (4549504 2747309)</span></span>
<span><span class="co">#&gt; 2 Haus für Mozart       theatre  NA              a     (4549003 2747376)</span></span>
<span><span class="co">#&gt; 3 Mozartsteg/Rudolfskai bus_stop NA              a     (4549589 2747507)</span></span>
<span><span class="co">#&gt; 4 Mozart Denkmal        artwork  NA              a     (4549387 2747514)</span></span>
<span><span class="co">#&gt; 5 Mozartsteg/Rudolfskai bus_stop NA              a     (4549491 2747551)</span></span>
<span><span class="co">#&gt; 6 Mozartsteg            bridge   NA              a     (4549473 2747624)</span></span>
<span><span class="co">#&gt; # ℹ 28 more rows</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # Edge data: 50 × 3</span></span>
<span><span class="co">#&gt;    from    to                           geometry</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt;                   &lt;LINESTRING [m]&gt;</span></span>
<span><span class="co">#&gt; 1     1     3 (4549504 2747309, 4549589 2747507)</span></span>
<span><span class="co">#&gt; 2     1     4 (4549504 2747309, 4549387 2747514)</span></span>
<span><span class="co">#&gt; 3     2     4 (4549003 2747376, 4549387 2747514)</span></span>
<span><span class="co">#&gt; # ℹ 47 more rows</span></span></code></pre>
<div class="sourceCode cell-code" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Join on edges duplicates edges that have multiple matches.</span></span>
<span><span class="co"># The number of edges in the resulting network is higher than in the original.</span></span>
<span><span class="va">net</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidygraph.data-imaginist.com/reference/activate.html" class="external-link">activate</a></span><span class="op">(</span><span class="va">edges</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html" class="external-link">st_join</a></span><span class="op">(</span><span class="va">two_equal_polys</span>, join <span class="op">=</span> <span class="va">st_intersects</span><span class="op">)</span></span></code></pre></div>
<pre class="fansi fansi-output"><code><span><span class="co">#&gt; # A sfnetwork: 17 nodes and 100 edges</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # A bipartite multigraph with 1 component and spatially explicit edges</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # Dimension: XY</span></span>
<span><span class="co">#&gt; # Bounding box: xmin: 4548664 ymin: 2747309 xmax: 4549589 ymax: 2748537</span></span>
<span><span class="co">#&gt; # Projected CRS: ETRS89-extended / LAEA Europe</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # Edge data: 100 × 4 (active)</span></span>
<span><span class="co">#&gt;    from    to                           geometry foo</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt;                   &lt;LINESTRING [m]&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1     1     3 (4549504 2747309, 4549589 2747507) a</span></span>
<span><span class="co">#&gt; 2     1     3 (4549504 2747309, 4549589 2747507) b</span></span>
<span><span class="co">#&gt; 3     1     4 (4549504 2747309, 4549387 2747514) a</span></span>
<span><span class="co">#&gt; 4     1     4 (4549504 2747309, 4549387 2747514) b</span></span>
<span><span class="co">#&gt; 5     2     4 (4549003 2747376, 4549387 2747514) a</span></span>
<span><span class="co">#&gt; 6     2     4 (4549003 2747376, 4549387 2747514) b</span></span>
<span><span class="co">#&gt; # ℹ 94 more rows</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # Node data: 17 × 4</span></span>
<span><span class="co">#&gt;   name                  type     website                        geometry</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;                 &lt;chr&gt;    &lt;chr&gt;                       &lt;POINT [m]&gt;</span></span>
<span><span class="co">#&gt; 1 Mozartkino            cinema   https://www.mozartki… (4549504 2747309)</span></span>
<span><span class="co">#&gt; 2 Haus für Mozart       theatre  NA                    (4549003 2747376)</span></span>
<span><span class="co">#&gt; 3 Mozartsteg/Rudolfskai bus_stop NA                    (4549589 2747507)</span></span>
<span><span class="co">#&gt; # ℹ 14 more rows</span></span></code></pre>
</div>
<p>For non-spatial joins based on attribute columns, simply use a join function from <code>dplyr</code> (e.g. <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">dplyr::left_join()</a></code> or <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">dplyr::inner_join()</a></code>) instead of <code><a href="https://r-spatial.github.io/sf/reference/st_join.html" class="external-link">sf::st_join()</a></code>.</p>
</section><section class="level3"><h3 id="join-points-to-their-nearest-node">Join points to their nearest node<a class="anchor" aria-label="anchor" href="#join-points-to-their-nearest-node"></a>
</h3>
<p>Another network specific use-case of spatial joins would be to join information from external points of interest (POIs) into the nodes of the network. However, to do so, such points need to have exactly equal coordinates to one of the nodes. Often this will not be the case. To solve such situations, you will first need to update the coordinates of the POIs to match those of their nearest node. This can be done using <code><a href="../reference/st_project_on_network.html">st_project_on_network()</a></code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a network.</span></span>
<span><span class="va">n1</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html" class="external-link">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">n2</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html" class="external-link">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">net</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf.html" class="external-link">st_sf</a></span><span class="op">(</span>geometry <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html" class="external-link">st_sfc</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html" class="external-link">st_linestring</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n1</span>, <span class="va">n2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/as_sfnetwork.html">as_sfnetwork</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a set of POIs.</span></span>
<span><span class="va">p1</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html" class="external-link">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html" class="external-link">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.6</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pois</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf.html" class="external-link">st_sf</a></span><span class="op">(</span></span>
<span>  poi_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bakery"</span>, <span class="st">"butcher"</span><span class="op">)</span>,</span>
<span>  geometry <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html" class="external-link">st_sfc</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Update coordinates of POIs to match their nearest node.</span></span>
<span><span class="va">ppois</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_project_on_network.html">st_project_on_network</a></span><span class="op">(</span><span class="va">pois</span>, <span class="va">net</span>, on <span class="op">=</span> <span class="st">"nodes"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggraph.data-imaginist.com/reference/ggraph.html" class="external-link">ggraph</a></span><span class="op">(</span><span class="va">net</span>, <span class="st">"sf"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">pois</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">poi_type</span><span class="op">)</span>,</span>
<span>    pch <span class="op">=</span> <span class="fl">8</span>, size <span class="op">=</span> <span class="fl">4</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_edge_sf.html" class="external-link">geom_edge_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_sf.html" class="external-link">geom_node_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggraph.data-imaginist.com/reference/ggraph.html" class="external-link">ggraph</a></span><span class="op">(</span><span class="va">net</span>, <span class="st">"sf"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_nearest_points.html" class="external-link">st_nearest_points</a></span><span class="op">(</span><span class="va">pois</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_combine</a></span><span class="op">(</span><span class="va">ppois</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"grey"</span>,</span>
<span>    linetype <span class="op">=</span> <span class="fl">2</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">pois</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">poi_type</span><span class="op">)</span>,</span>
<span>    pch <span class="op">=</span> <span class="fl">8</span>, size <span class="op">=</span> <span class="fl">4</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_edge_sf.html" class="external-link">geom_edge_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_sf.html" class="external-link">geom_node_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">ppois</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">poi_type</span><span class="op">)</span>,</span>
<span>    pch <span class="op">=</span> <span class="fl">8</span>, size <span class="op">=</span> <span class="fl">4</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="sfn04_join_filter_files/figure-html/unnamed-chunk-16-1.png" width="672"></p>
<figcaption>Original network and POIs</figcaption></figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="sfn04_join_filter_files/figure-html/unnamed-chunk-16-2.png" width="672"></p>
<figcaption>POIs snapped to the network</figcaption></figure>
</div>
</div>
</div>
</div>
<p>After snapping the POIs, we can use <code><a href="https://r-spatial.github.io/sf/reference/st_join.html" class="external-link">sf::st_join()</a></code> as expected. Do remember that if multiple POIs are snapped to the same node, only the information of the first one is joined into the network, unless you set <code>ignore_multiple = FALSE</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html" class="external-link">st_join</a></span><span class="op">(</span><span class="va">net</span>, <span class="va">ppois</span><span class="op">)</span></span></code></pre></div>
<pre class="fansi fansi-output"><code><span><span class="co">#&gt; # A sfnetwork: 2 nodes and 1 edges</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # A rooted tree with spatially explicit edges</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # Dimension: XY</span></span>
<span><span class="co">#&gt; # Bounding box: xmin: 0 ymin: 0 xmax: 1 ymax: 0</span></span>
<span><span class="co">#&gt; # CRS: NA</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # Node data: 2 × 2 (active)</span></span>
<span><span class="co">#&gt;   geometry poi_type</span></span>
<span><span class="co">#&gt;    &lt;POINT&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1    (0 0) bakery</span></span>
<span><span class="co">#&gt; 2    (1 0) butcher</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # Edge data: 1 × 3</span></span>
<span><span class="co">#&gt;    from    to     geometry</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;LINESTRING&gt;</span></span>
<span><span class="co">#&gt; 1     1     2   (0 0, 1 0)</span></span></code></pre>
</div>
</section><section class="level3"><h3 id="blending-points-into-a-network">Blending points into a network<a class="anchor" aria-label="anchor" href="#blending-points-into-a-network"></a>
</h3>
<p>In the example above, it makes sense to include the information from the first POI in an already existing node. For the second POI, however, its nearest node is quite far away relative to the nearest location on its nearest edge. In that case, you might want to split the edge at that location, and add a new node to the network. For this combination process we use the metaphor of throwing the network and POIs together in a blender, and mix them smoothly together.</p>
<p>The function <code><a href="../reference/st_network_blend.html">st_network_blend()</a></code> does exactly that. For each POI, it finds the nearest location <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math> on the nearest edge <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>e</mi><annotation encoding="application/x-tex">e</annotation></semantics></math>. If <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math> is an already existing node (i.e. <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math> is an endpoint of <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>e</mi><annotation encoding="application/x-tex">e</annotation></semantics></math>), it joins the information from the POI into that node. If <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math> is not an already existing node, it subdivides <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>e</mi><annotation encoding="application/x-tex">e</annotation></semantics></math> at <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math>, adds <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math> as a new node to the network, and joins the information from the POI into that new node. For this process, it does not matter if <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math> is an interior point in the linestring geometry of <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>e</mi><annotation encoding="application/x-tex">e</annotation></semantics></math>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">blend</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_network_blend.html">st_network_blend</a></span><span class="op">(</span><span class="va">net</span>, <span class="va">pois</span><span class="op">)</span></span>
<span><span class="va">blend</span></span></code></pre></div>
<pre class="fansi fansi-output"><code><span><span class="co">#&gt; # A sfnetwork: 3 nodes and 2 edges</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # A rooted tree with spatially explicit edges</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # Dimension: XY</span></span>
<span><span class="co">#&gt; # Bounding box: xmin: 0 ymin: 0 xmax: 1 ymax: 0</span></span>
<span><span class="co">#&gt; # CRS: NA</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # Node data: 3 × 2 (active)</span></span>
<span><span class="co">#&gt;   geometry poi_type</span></span>
<span><span class="co">#&gt;    &lt;POINT&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1    (0 0) bakery</span></span>
<span><span class="co">#&gt; 2    (1 0) NA</span></span>
<span><span class="co">#&gt; 3  (0.6 0) butcher</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # Edge data: 2 × 3</span></span>
<span><span class="co">#&gt;    from    to     geometry</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;LINESTRING&gt;</span></span>
<span><span class="co">#&gt; 1     1     3 (0 0, 0.6 0)</span></span>
<span><span class="co">#&gt; 2     3     2 (0.6 0, 1 0)</span></span></code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggraph.data-imaginist.com/reference/ggraph.html" class="external-link">ggraph</a></span><span class="op">(</span><span class="va">net</span>, <span class="st">"sf"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">pois</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">poi_type</span><span class="op">)</span>,</span>
<span>    pch <span class="op">=</span> <span class="fl">8</span>, size <span class="op">=</span> <span class="fl">4</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_edge_sf.html" class="external-link">geom_edge_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_sf.html" class="external-link">geom_node_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggraph.data-imaginist.com/reference/ggraph.html" class="external-link">ggraph</a></span><span class="op">(</span><span class="va">blend</span>, <span class="st">"sf"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_nearest_points.html" class="external-link">st_nearest_points</a></span><span class="op">(</span><span class="va">pois</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_combine</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">blend</span>, <span class="st">"nodes"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"grey"</span>,</span>
<span>    linetype <span class="op">=</span> <span class="fl">2</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">pois</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">poi_type</span><span class="op">)</span>,</span>
<span>    pch <span class="op">=</span> <span class="fl">8</span>, size <span class="op">=</span> <span class="fl">4</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_edge_sf.html" class="external-link">geom_edge_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_sf.html" class="external-link">geom_node_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="sfn04_join_filter_files/figure-html/unnamed-chunk-19-1.png" width="672"></p>
<figcaption>Original network and POIs</figcaption></figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="sfn04_join_filter_files/figure-html/unnamed-chunk-19-2.png" width="672"></p>
<figcaption>POIs blended into the network</figcaption></figure>
</div>
</div>
</div>
</div>
<p>The <code><a href="../reference/st_network_blend.html">st_network_blend()</a></code> function has a <code>tolerance</code> parameter, which defines the maximum distance a POI can be from the network in order to be blended in. Hence, only the POIs that are at least as close to the network as the tolerance distance will be blended, and all others will be ignored. The tolerance can be specified as a non-negative number. By default it is assumed its units are meters, but this behavior can be changed by manually setting its units with <code><a href="https://r-quantities.github.io/units/reference/units.html" class="external-link">units::units()</a></code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Update the POIs.</span></span>
<span><span class="va">p3</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html" class="external-link">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pois</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf.html" class="external-link">st_sf</a></span><span class="op">(</span></span>
<span>  poi_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bakery"</span>, <span class="st">"butcher"</span>, <span class="st">"bar"</span><span class="op">)</span>,</span>
<span>  geometry <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html" class="external-link">st_sfc</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, <span class="va">p3</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">blend</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_network_blend.html">st_network_blend</a></span><span class="op">(</span><span class="va">net</span>, <span class="va">pois</span><span class="op">)</span></span>
<span><span class="va">blend_with_tolerance</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_network_blend.html">st_network_blend</a></span><span class="op">(</span><span class="va">net</span>, <span class="va">pois</span>, tolerance <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggraph.data-imaginist.com/reference/ggraph.html" class="external-link">ggraph</a></span><span class="op">(</span><span class="va">blend</span>, <span class="st">"sf"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_nearest_points.html" class="external-link">st_nearest_points</a></span><span class="op">(</span><span class="va">pois</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_combine</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">blend</span>, <span class="st">"nodes"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"grey"</span>,</span>
<span>    linetype <span class="op">=</span> <span class="fl">2</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">pois</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">poi_type</span><span class="op">)</span>,</span>
<span>    pch <span class="op">=</span> <span class="fl">8</span>, size <span class="op">=</span> <span class="fl">4</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_edge_sf.html" class="external-link">geom_edge_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_sf.html" class="external-link">geom_node_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggraph.data-imaginist.com/reference/ggraph.html" class="external-link">ggraph</a></span><span class="op">(</span><span class="va">blend_with_tolerance</span>, <span class="st">"sf"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_nearest_points.html" class="external-link">st_nearest_points</a></span><span class="op">(</span><span class="va">pois</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_combine</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">blend</span>, <span class="st">"nodes"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"grey"</span>,</span>
<span>    linetype <span class="op">=</span> <span class="fl">2</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">pois</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">poi_type</span><span class="op">)</span>,</span>
<span>    pch <span class="op">=</span> <span class="fl">8</span>, size <span class="op">=</span> <span class="fl">4</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_edge_sf.html" class="external-link">geom_edge_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_sf.html" class="external-link">geom_node_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="sfn04_join_filter_files/figure-html/unnamed-chunk-21-1.png" width="672"></p>
<figcaption>Blend without tolerance</figcaption></figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="sfn04_join_filter_files/figure-html/unnamed-chunk-21-2.png" width="672"></p>
<figcaption>Blend with tolerance</figcaption></figure>
</div>
</div>
</div>
</div>
<p>There are a few important details to be aware of when using <code><a href="../reference/st_network_blend.html">st_network_blend()</a></code>. Firstly: when multiple POIs have the same nearest location on the nearest edge, only the first of them is blended into the network. This is for the same reasons as explained before: in the network structure there is no clear approach for dealing with duplicated nodes. By arranging your table of POIs with <code><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">dplyr::arrange()</a></code> before blending you can influence which (type of) POI is given priority in such cases. There is also the option to set <code>ignore_duplicates = FALSE</code>. Then, duplicated projections will result in duplicated nodes, but these duplicates are isolated (i.e. not connected to the rest of the network). You can then use the morpher <code><a href="../reference/spatial_morphers.html">to_spatial_unique()</a></code> to merge spatially duplicated nodes into one, specifying how their attributes should be combined. See <a href="https://luukvdmeer.github.io/sfnetworks/articles/sfn03_cleaning.html/#merge-nodes-at-equal-locations">here</a> for an example.</p>
<p>Secondly: when a single POI has multiple nearest edges, it is only blended into the first of these edges. Therefore, it might be a good idea to run the <code><a href="../reference/spatial_morphers.html">to_spatial_subdivision()</a></code> morpher after blending, such that intersecting but unconnected edges get connected.</p>
<p>Lastly: it is important to be aware of <em>floating point precision</em>. See the discussion in <a href="https://github.com/r-spatial/sf/issues/790" class="external-link">this GitHub issue</a> for more background. In short: due to internal rounding of rational numbers in R it is actually possible that even the intersection point between two lines is <em>not</em> evaluated as intersecting those lines themselves. Sounds confusing? It is! But see the example below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create two intersecting lines.</span></span>
<span><span class="va">p1</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html" class="external-link">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.53236</span>, <span class="fl">1.95377</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html" class="external-link">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.53209</span>, <span class="fl">1.95328</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">l1</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html" class="external-link">st_sfc</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html" class="external-link">st_linestring</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p3</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html" class="external-link">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.53209</span>, <span class="fl">1.95345</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p4</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html" class="external-link">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.53245</span>, <span class="fl">1.95345</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">l2</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html" class="external-link">st_sfc</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html" class="external-link">st_linestring</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">p3</span>, <span class="va">p4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The two lines share an intersection point.</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html" class="external-link">st_intersection</a></span><span class="op">(</span><span class="va">l1</span>, <span class="va">l2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Geometry set for 1 feature </span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 0.5321837 ymin: 1.95345 xmax: 0.5321837 ymax: 1.95345</span></span>
<span><span class="co">#&gt; CRS:           NA</span></span>
<span><span class="co">#&gt; POINT (0.5321837 1.95345)</span></span>
<span></span>
<span><span class="co"># But this intersection point does not intersects the line itself!</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html" class="external-link">st_intersects</a></span><span class="op">(</span><span class="va">l1</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html" class="external-link">st_intersection</a></span><span class="op">(</span><span class="va">l1</span>, <span class="va">l2</span><span class="op">)</span>, sparse <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt;       [,1]</span></span>
<span><span class="co">#&gt; [1,] FALSE</span></span>
<span></span>
<span><span class="co"># The intersection point is instead located a tiny bit next to the line.</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html" class="external-link">st_distance</a></span><span class="op">(</span><span class="va">l1</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html" class="external-link">st_intersection</a></span><span class="op">(</span><span class="va">l1</span>, <span class="va">l2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;              [,1]</span></span>
<span><span class="co">#&gt; [1,] 4.310191e-17</span></span></code></pre></div>
</div>
<p>That is: you would expect an intersection with an edge to be blended into the network even if you set <code>tolerance = 0</code>, but in fact that will not always happen. To avoid having these problems, you can better set the tolerance to a very small number instead of zero.</p>
<div class="sourceCode cell-code" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">net</span> <span class="op">=</span> <span class="fu"><a href="../reference/as_sfnetwork.html">as_sfnetwork</a></span><span class="op">(</span><span class="va">l1</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html" class="external-link">st_intersection</a></span><span class="op">(</span><span class="va">l1</span>, <span class="va">l2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">l1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">l2</span>, col <span class="op">=</span> <span class="st">"grey"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/st_network_blend.html">st_network_blend</a></span><span class="op">(</span><span class="va">net</span>, <span class="va">p</span>, tolerance <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">2</span>, cex <span class="op">=</span> <span class="fl">2</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: [1m[22m`st_network_blend()` did not blend any points into the network.</span></span>
<span><span class="co">#&gt; [36mℹ[39m Increase `tolerance` for a higher tolerance distance.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">l1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">l2</span>, col <span class="op">=</span> <span class="st">"grey"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/st_network_blend.html">st_network_blend</a></span><span class="op">(</span><span class="va">net</span>, <span class="va">p</span>, tolerance <span class="op">=</span> <span class="fl">1e-10</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">2</span>, cex <span class="op">=</span> <span class="fl">2</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="cell quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="sfn04_join_filter_files/figure-html/unnamed-chunk-23-1.png" width="672"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="sfn04_join_filter_files/figure-html/unnamed-chunk-23-2.png" width="672"></p>
</div>
</div>
</div>
</section><section class="level3"><h3 id="joining-two-networks">Joining two networks<a class="anchor" aria-label="anchor" href="#joining-two-networks"></a>
</h3>
<p>In the examples above it was all about joining information from external features into a network. But how about joining two networks? This is what the <code><a href="../reference/st_network_join.html">st_network_join()</a></code> function is for. It takes two sfnetworks as input and makes a spatial full join on the geometries of the nodes data, based on the <em>equals</em> spatial predicate. That means, all nodes from network x and all nodes from network y are present in the joined network, but if there were nodes in x with equal geometries to nodes in y, these nodes become a single node in the joined network. Edge data are combined using a <code><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">dplyr::bind_rows()</a></code> semantic, meaning that data are matched by column name and values are filled with <code>NA</code> if missing in either of the networks. The <em>from</em> and <em>to</em> columns in the edge data are updated automatically such that they correctly match the new node indices of the joined network. There is no spatial join performed on the edges. Hence, if there is an edge in x with an equal geometry to an edge in y, they remain separate edges in the joined network.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create two networks.</span></span>
<span><span class="co"># Create a network.</span></span>
<span><span class="va">n1</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html" class="external-link">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">n2</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html" class="external-link">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">n3</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html" class="external-link">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">n4</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html" class="external-link">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">e1</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html" class="external-link">st_sfc</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html" class="external-link">st_linestring</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n1</span>, <span class="va">n2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">e2</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html" class="external-link">st_sfc</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html" class="external-link">st_linestring</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n2</span>, <span class="va">n3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">e3</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html" class="external-link">st_sfc</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html" class="external-link">st_linestring</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n3</span>, <span class="va">n4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">neta</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf.html" class="external-link">st_sf</a></span><span class="op">(</span>geometry <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">e1</span>, <span class="va">e2</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/as_sfnetwork.html">as_sfnetwork</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">netb</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf.html" class="external-link">st_sf</a></span><span class="op">(</span>geometry <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">e2</span>, <span class="va">e3</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/as_sfnetwork.html">as_sfnetwork</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Join them into a single network.</span></span>
<span><span class="va">joined</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_network_join.html">st_network_join</a></span><span class="op">(</span><span class="va">neta</span>, <span class="va">netb</span><span class="op">)</span></span>
<span><span class="va">joined</span></span></code></pre></div>
<pre class="fansi fansi-output"><code><span><span class="co">#&gt; # A sfnetwork: 4 nodes and 4 edges</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # A directed acyclic multigraph with 1 component and spatially explicit edges</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # Dimension: XY</span></span>
<span><span class="co">#&gt; # Bounding box: xmin: 0 ymin: 0 xmax: 1 ymax: 1</span></span>
<span><span class="co">#&gt; # CRS: NA</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # Node data: 4 × 1 (active)</span></span>
<span><span class="co">#&gt;   geometry</span></span>
<span><span class="co">#&gt;    &lt;POINT&gt;</span></span>
<span><span class="co">#&gt; 1    (0 0)</span></span>
<span><span class="co">#&gt; 2    (1 0)</span></span>
<span><span class="co">#&gt; 3    (1 1)</span></span>
<span><span class="co">#&gt; 4    (0 1)</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # Edge data: 4 × 3</span></span>
<span><span class="co">#&gt;    from    to     geometry</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;LINESTRING&gt;</span></span>
<span><span class="co">#&gt; 1     1     2   (0 0, 1 0)</span></span>
<span><span class="co">#&gt; 2     2     3   (1 0, 1 1)</span></span>
<span><span class="co">#&gt; 3     2     3   (1 0, 1 1)</span></span>
<span><span class="co">#&gt; # ℹ 1 more row</span></span></code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">neta</span>, col <span class="op">=</span> <span class="st">"skyblue"</span>, pch <span class="op">=</span> <span class="fl">15</span>, cex <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">netb</span>, col <span class="op">=</span> <span class="st">"orange"</span>, pch <span class="op">=</span> <span class="fl">18</span>, cex <span class="op">=</span> <span class="fl">2</span>, lty <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">4</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">joined</span>, cex <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<div class="cell quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="sfn04_join_filter_files/figure-html/unnamed-chunk-25-1.png" width="672"></p>
<figcaption>Two networks</figcaption></figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="sfn04_join_filter_files/figure-html/unnamed-chunk-25-2.png" width="672"></p>
<figcaption>Joined network</figcaption></figure>
</div>
</div>
</div>
</div>
</section></section><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'light-border',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config);
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script></main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Lucas van der Meer, Lorena Abad, Andrea Gilardi, Robin Lovelace.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
